
@startuml

'ENTITY
class Submission {
    - id: long
    - submissionStatus: SubmissionStatus
    - location: Point
    - note: String
    - createdAt: LocalDateTime
    - observedAt: LocalDateTime
    - temperatureCelsius: Double
    - altitudeMeters: Double
    + getSubmissionId(): String
    + getStatus(): SubmissionStatus
    + setStatus(): SubmissionStatus
    + getCreatedAt(): LocalDateTime
    + setCreatedAt(): LocalDateTime
    + getTemperatureCelsius(): Double
    + setTemperatureCelsius(): Double
    + getAltitudeMeters(): Double
    + setAltitudeMeters(): Double
}

class SpeciesSpotting {
    - photoUrl: String
    + isValid(): boolean
    + getSpecies(): Species
    + setSpecies(): Species
}

class Species {
    - scientificName: String
    - category: String
}

class PollutionReport {
    - sensorType: String
    - pm25: Double
    - pm10: Double
    - durationHours: Double

    + getSensorType(): String
    + setSensorType(String)
    + getPM25(): Double
    + setPM25(Double)
    + getPM10(): Double
    + setPM10(Double)
    + getDurationHours()
    + setDurationHours(Double)
}

class UserEntity {
    - userId: long
    - username: String
    - fullName: String
    - email: String
    - profilePictureURL: String
    - biography: String
    - role: UserRole

    + register(username: String, email: String, password: String)
    + login(password: String): boolean
    + updateProfile(displayName: String, bio: String, profilePictureUrl: String)
    + changePassword(oldPassword: String, newPassword: String): boolean
    + deactivateAccount()
}
' USER Service
class UserDetails {
    - username
    - passwordHash
}
note right: This is a Spring internjal class

class UserService {
    + registerUser(NewUserInfo)
    + registerUser(UserEntity)
    + getEntityFromUserDetails()

    - throwIfInvalidNewUserEntity(UserEntity)
    - throwIfAlreadyExistingUser(UserEntity)
}
UserService --> UserDetails
UserService --> UserEntity
ProfileView --> UserService

'UI
class AbstractSubmissionView<T extends Submission> {
    # AbstractSubmissionView(T submission, String title)

    + setReadOnly()
    + allowWrite()
    + refreshFields()
    + getCoordinate()

    - configureStyle(String title)
    - createCoordinateFields()
    - bindCoordinateFields()
    - createFormLayout()

    # createFields()
    # bindFields()
    # getFormComponents()
    # extractCoordinates()
}

class SpeciesSubmissionView {
    + SpeciesSubmissionView(SpeciesSpotting)
    + setSpeciesSuggestions(Function<String, List<String>> lambda)
}

class PollutionReportView {
    + PollutionReportView(PollutionReport)
}

AbstractSubmissionView <-- SpeciesSubmissionView
AbstractSubmissionView <-- PollutionReportView

class SubmissionViewFactory {
    + createSubmissionView()
    + createSubmissionForm()
}

SubmissionViewFactory --> AbstractSubmissionView : creates implementation of

'MAP
class MapComponent {
    + clearMap(MapClearEvent)
    + getMap()
}
note right
Map Controller just holds a Vaadin Map
end note

class MarkerFeature {
}
note right: This as a Vaadin SDK Class

class Blip {
    - Blip(Coordinate,Submission)

    + createBlip(double, double): Blip
    + createBlip(Submission): Blip
}
MarkerFeature <|-- Blip

class GridComponent {
    + set(List<Submission> submissions)
}
GridComponent --> MapView
GridComponent --> BlipLoaderObserver

class FilterCriteria {
    + startDate: LocalDateTime
    + endDate: LocalDateTime
    + submissionType: SubmissionType
    + speciesName: String
    + minPM25: float
    + maxPM25: float
    + minPM10: float
    + maxPM10: float
}

' Map Observers
class SpringEventPublisher {
    + registerListener()
    + publish(Object Event)
}
note right: This is not a real class, I'm not sure what Spring actually uses

class PublisherFacadeComponent {
    + publishEvent(Object Event)
    + steal(Publisher)
}
MapComponent --> PublisherFacadeComponent : publishes to
PublisherFacadeComponent --> SpringEventPublisher

interface Publisher {
    + publish()
}

class AveragingComponent {
    + newAveragingReport(AveragingDoneEvent)
    + startAveragingMode()
    + getBoxClick(AveragingEvent)
    + publishCurrentReport(AveragingDoneEvent)
    + stopAveragingMode()
}
AveragingComponent --> SpringEventPublisher: observes
AveragingComponent --> PublisherFacadeComponent: steals from

class AveragingPublisher {
    + publish()
}
AveragingComponent *-- AveragingPublisher
AveragingPublisher --> SpringEventPublisher : publishes to

class BlipClickObserver {
    + onRowClick(RowClickEvent)
    + onBlipClick(MapFeatureClickEvent)
    - openSubmission()
}

class SubmissionProxy {
    + getSubmission(Long id)
}
BlipClickObserver --> SubmissionProxy : queries
SubmissionProxy --> SubmissionService
BlipClickObserver --> SpringEventPublisher : observes


class BlipLoaderObserver {
    + resetAfterClear(MapClearEvent)
    + loadBlipsOnDrag(MapViewMoveEndEvent)
    - loadBlips()
}
BlipLoaderObserver --> SpringEventPublisher : observes

' REPOSITORY
interface JpaRepository {
    + save(Object)
    + findAll(Example<S>)
}
note right
    This interface is provided by Spring.
    It contains many methods.
    I only include methods here that I'm using
end note

interface SubmissionRepository {
    + findAllWithinArea(area: Geometry): List<Submission>
    + findByUser(user: User): List<Submission>
}

interface SpeciesRepository {
    + fuzzySearchSpeciesName(String): List<Species>
}

class SubmissionService {
    + findWithinGeometry(Geometry geometry): List<Submission>
    + findById(Long id): Optional<Submission>
    + findAllByCriteria(FilterCriteria criteria): List<Submission>
    + save(Submission submission): Submission
    + getAll(): List<Submission>
    - byCriteria(FilterCriteria c): Specification<Submission>
}

SubmissionRepository --|> JpaRepository
SpeciesRepository --|> JpaRepository

SpeciesRepository "1" o-- "0..*" Species : persists >
' END REPOSITORY

Submission <|-- SpeciesSpotting
Submission <|-- PollutionReport
SpeciesSpotting "1" o-> "1" Species: is >
MapComponent *-- Blip
MapView --> MapComponent
FilterComponent "1" --> "1" BlipLoaderObserver : advises >
FilterComponent "1" --> "0..*" FilterCriteria: generates >
SubmissionRepository "1" o-- "0..*" Submission : persists >
ProfileView "1" --> "1" UserEntity : handles >
UserEntity "1" --> "0..*" Submission : owns >

SubmissionService --> SubmissionRepository : calls
SubmissionService --> SpeciesRepository : calls
BlipClickObserver --> SubmissionViewFactory : creates window from

' Bucket Service
class BucketService {
    + getSignedDownloadURL(String): URL
    + uploadSubmissionPhoto(Long, data, contentType)
}
BucketService --> SubmissionViewFactory

' Geometry Helper
class GeometryHelper {
    + getJTSPoint(Coordinate)
    + rectangleFromPoints()
}

class VaadinCoordinateAdapter {
    + VaadinCoordinateAdapter(JTSCoordinate)
}
@enduml